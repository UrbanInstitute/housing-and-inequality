<!DOCTYPE html>
<meta charset="utf-8">
<style>

#chart{
  max-width: 950px;
  width: 100%;
}
.barAddRETD_MID, .legendAddRETD_MID {
  fill: #1696d2;
  opacity: .7;
}
.barAddHS, .legendAddHS{
  fill: #fcb918;
  opacity: .7;
}

.axis, .xText, .legendTextAddRETD_MID, .legendTextAddHS{
  font: 14px Lato;
  pointer-events: none;

/*      -webkit-filter: drop-shadow(4px 4px 6px #ccc);
    -moz-filter: drop-shadow(4px 4px 6px #ccc);
    filter: drop-shadow(4px 4px 6px #ccc);*/
}
/*.legendTextAddRETD_MID, .legendTextAddHS{
  fill: #333;
}*/
.legendTextAddRETD_MID.shadow, .legendTextAddHS.shadow{
  fill: #000;
  pointer-events: none;
}
.xText, .yT
.xText, .yText{
  font-style: italic;
}

.axis path{
  display: none;
}
.x.axis line{
  display: none;
}
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.x.axis path {
  display: none;
}

.textAddRETD_MID, .textAddHS{
  font: 14px Lato;
  pointer-events: none;
}


#chartText{
  font: 16px Lato;
  height: 180px;
  position: relative;
  /* right: 0; */
  bottom: -250px;
  left: 52%;
  /* display: inline; */
  width: 350px;
  pointer-events: none;
}
.button{
  color: #ffffff;
  background-color: #666666;
  display: inline-block;
  width: 20px;
  margin-top: 145px;
  padding: 3px;
  cursor: pointer;
  font: 14px Lato;
  font-weight: 900;
  float:left;
  text-align: center;
  border: 1px solid #fff;
  cursor: pointer;
  pointer-events: visible;
}
.greyed, .greyed:hover{
  color: #fff;
  background-color: #e6e7e8;
  pointer-events: none;
  cursor: default;
}
.button:hover{
  background-color: #333;
  color: #fff;
}
#stepCount{
  display: none;
}
.stepText{
  position: absolute;
  opacity: 0;
  pointer-events: none;
}
</style>
<body>

<div id = "chart">
  <div id = "chartText">
  <p class = "stepText one">This graph shows the dollar increase in income bracket cutoffs, when housing subsidies are added in. The income cutoffs on the lower portion of the distribution rise, while the cutoffs in higher percentiles remain stable. Housing subsidies reduce inequality.</p>
  <p class = "stepText two">Adding in the mortgage interest and real estate tax deductions appears to dramatically increase inequality, however it is misleading to look at dollar differences in income cutoffs...</p>
  <p class = "stepText three">When we look at dollar differences as a percentage of income cutoffs, we see that the mortgage interest and real estate tax deductions only slightly increase inequality.</p>
  <div class = "button prev greyed"><</div>
  <div class = "button one">1</div>
  <div class = "button two greyed">2</div>
  <div class = "button three greyed">3</div>
  <div class = "button next">></div>
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script>
var DOLLARS = d3.format("$")
var PERCENT = d3.format(".1%")

function greyPrev(){
    d3.select(".button.prev").classed("greyed", true);
    d3.select(".button.next").classed("greyed", false);
    d3.select(".button.one").classed("greyed", false);
    d3.select(".button.two").classed("greyed", true);
    d3.select(".button.three").classed("greyed", true);
}
function greyNext(){
  d3.select(".button.prev").classed("greyed", false);
  d3.select(".button.next").classed("greyed", true);
  d3.select(".button.one").classed("greyed", true);
  d3.select(".button.two").classed("greyed", true);
  d3.select(".button.three").classed("greyed", false);
}
function greyNone(){
  d3.select(".button.prev").classed("greyed", false);
  d3.select(".button.next").classed("greyed", false);
  d3.select(".button.one").classed("greyed", true);
  d3.select(".button.two").classed("greyed", false);
  d3.select(".button.three").classed("greyed", true);
}
function dollarDisplay(){
  d3.select(".yText")
  .text("Dollar difference");  
}
function percentDisplay(){
  d3.select(".yText")
  .transition()
  .style("opacity",1)
  .text("Percent difference");  
}


function drawGraphic(){
  d3.select(".stepText.one").style("opacity",1);
  d3.select(".stepText.two").style("opacity",0);
  d3.select(".stepText.three").style("opacity",0);
  greyPrev();

  d3.select("#chart svg").remove();
  var stepCount = 1;
  var margin = {top: 40, right: 20, bottom: 80, left: 60};
  var width = d3.select("#chart").node().getBoundingClientRect().width - margin.left - margin.right;
  var height = width * .4;
      // width = 960 - margin.left - margin.right,
      // height = 500 - margin.top - margin.bottom;

  var x = d3.scale.ordinal()
      .rangeRoundBands([0, width], .02);

  var y = d3.scale.linear()
      .range([height, 0]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left")
      .ticks(10, "$,");

  var svg = d3.select("#chart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
  var defs = svg.append("defs");
  var filter = defs.append("filter")
        .attr("id", "shadow")
        .attr("x", "-20%")
        .attr("y", "-19%")
        .attr("height", "180%")
        .attr("width", "180%")
    filter.append("feGaussianBlur")
        .attr("stdDeviation", "2 2")
        .attr("result", "shadow");
     
    filter.append("feOffset")
        .attr("dx", 2)
        .attr("dy", 2)

  d3.csv("data/data.csv", function(error, data) {
    if (error) throw error;

    x.domain(data.map(function(d) { return d.percentile; }));
    y.domain([0, 1940]);



    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis)
      .append("text")
        .attr("class", "yText")
        .attr("y", 6)
        .attr("dy", "-2em")
        .attr("dx", "-4em")
        .text("Dollar difference");

    svg.append("text")
      .attr("class", "xText")
      .attr("y", 400)
      .attr("x", 420)
      .text("Percentile")

    svg.selectAll(".textAddHS ")
        .data(data)
      .enter().append("text")
        .attr("class", function(d){ return "textAddHS d" + d.percentile})
        .attr("x", function(d) { return x(d.percentile); })
        .attr("y", function(d) { return y(d.dollars_add_hs); })
        .attr("dx", x.rangeBand()/2)
        .style("text-anchor", "middle")
        .attr("dy", "-.71em")
        .text(function(d){ return DOLLARS(d.dollars_add_hs)})
        .style("opacity", 0)

    svg.selectAll(".barAddHS")
        .data(data)
      .enter().append("rect")
        .attr("class", "barAddHS")
        .attr("x", function(d) { return x(d.percentile); })
        .attr("width", x.rangeBand())
        .attr("y", function(d) { return y(d.dollars_add_hs); })
        .attr("height", function(d) { return height - y(d.dollars_add_hs); })
        .on("mouseover", function(d){
          d3.select(this)
            .transition()
            .duration(300)
            .style("opacity", .9)
          d3.select(".textAddHS.d" + d.percentile)
            .transition()
            .duration(300)
            .style("opacity",1)
        })
        .on("mouseout", function(d){
          d3.select(this)
            .transition()
            .duration(300)
            .style("opacity", .7)

          d3.select(".textAddHS.d" + d.percentile)
            .transition()
            .duration(300)
            .style("opacity",0)
        })


    svg.selectAll(".textAddRETD_MID ")
        .data(data)
      .enter().append("text")
        .attr("class", function(d){ return "textAddRETD_MID d" + d.percentile})
        .attr("x", function(d) { return x(d.percentile); })
        .attr("y", function(d) { return y(d.dollars_add_hs_add_retd_mid); })
        .attr("dx", x.rangeBand()/2)
        .style("text-anchor", "middle")
        .attr("dy", "-.71em")
        .text(function(d){ return DOLLARS(d.dollars_add_hs_add_retd_mid)})
        .style("opacity", 0)

    
    svg.selectAll(".barAddRETD_MID")
        .data(data)
      .enter().append("rect")
        .attr("class", "barAddRETD_MID")
        .attr("x", function(d) { return x(d.percentile); })
        .attr("width", x.rangeBand())
        .attr("y", height)
        .attr("height", 0);

    // svg.append("text")
    //   .attr("class", "legendTextAddHS shadow")
    //   .style("filter", "url(#shadow)")
    //   .attr("x", x(15)-40)
    //   .attr("y", y(250))
    //   .text("Adding housing subsidies")
    svg.append("text")
      .attr("class", "legendTextAddHS")
      .attr("x", x(15)-40)
      .attr("y", y(250))
      .text("Adding housing subsidies")



    // svg.append("text")
    //   .attr("class", "legendTextAddRETD_MID shadow")
    //   .style("filter", "url(#shadow)")
    //   .attr("x", x(70))
    //   .attr("y", y(-1000))
    //   .text("Adding housing subsidies")
    // svg.append("text")
    //   .attr("class", "legendTextAddRETD_MID shadow lower")
    //   .style("filter", "url(#shadow)")
    //   .attr("x", x(75)-20)
    //   .attr("y", y(-1000))
    //   .text("and deductions")

    svg.append("text")
      .attr("class", "legendTextAddRETD_MID")
      .attr("x", x(70))
      .attr("y", y(-2000))
      .text("Adding housing subsidies")
    svg.append("text")
      .attr("class", "legendTextAddRETD_MID lower")
      .attr("x", x(75)-20)
      .attr("y", y(-2000))
      .text("and deductions")

    function hideLabel(){
      d3.selectAll(".legendTextAddRETD_MID")
        .transition()
        .attr("y", y(-2000))
    }
    function lowerLabel(){
      d3.selectAll(".legendTextAddRETD_MID:not(.lower)")
        .transition()
        .attr("y", y(.028))
      d3.selectAll(".legendTextAddRETD_MID.lower")
        .transition()
        .attr("y", y(.023))

    }
    function showLabel(){
      d3.selectAll(".legendTextAddRETD_MID:not(.lower)")
        .transition()
        .attr("y", y(300))
      d3.selectAll(".legendTextAddRETD_MID.lower")
        .transition()
        .attr("y", y(200))
    }

    d3.selectAll(".button").on("click", function(){
      var next = d3.select(this).classed("next")
      var prev = d3.select(this).classed("prev")

      if(stepCount == 1 && next){
        d3.select(".stepText.one").transition().style("opacity",0)
        d3.select(".stepText.two").transition().style("opacity",1)
        d3.select(".stepText.three").transition().style("opacity",0)
        d3.selectAll(".barAddRETD_MID")
          .on("mouseover", function(d){
            d3.select(this)
              .transition()
              .duration(300)
              .style("opacity", .9)
            d3.select(".textAddRETD_MID.d" + d.percentile)
              .transition()
              .duration(300)
              .style("opacity",1)
          })
          .on("mouseout", function(d){
            d3.select(this)
              .transition()
              .duration(300)
              .style("opacity", .7)

            d3.select(".textAddRETD_MID.d" + d.percentile)
              .transition()
              .duration(300)
              .style("opacity",0)
          })
          .transition()
          .attr("y", function(d) { return y(d.dollars_add_hs_add_retd_mid); })
          .attr("height", function(d) { return height - y(d.dollars_add_hs_add_retd_mid); });


        stepCount += 1;
        greyNone();
        showLabel();
      }
      else if(stepCount == 2 && prev){
        d3.select(".stepText.one").transition().style("opacity",1)
        d3.select(".stepText.two").transition().style("opacity",0)
        d3.select(".stepText.three").transition().style("opacity",0)
        d3.selectAll(".barAddRETD_MID").transition()
          .attr("y", height)
          .attr("height", 0);
        stepCount -= 1;      
        greyPrev();
        hideLabel();
      }

      else if(stepCount == 2 && next){
        d3.select
        d3.select(".stepText.one").transition().style("opacity",0)
        d3.select(".stepText.two").transition().style("opacity",0)
        d3.select(".stepText.three").transition().style("opacity",1)
        yAxis.ticks(10, "%");
        y.domain([0,.1])
         svg.select(".y.axis").transition().duration(1700).call(yAxis);
        d3.selectAll(".barAddRETD_MID").transition()
          .attr("y", function(d) { return y(d.percent_add_hs_add_retd_mid); })
          .attr("height", function(d) { return height - y(d.percent_add_hs_add_retd_mid); });
        d3.selectAll(".textAddRETD_MID")
          .attr("y", function(d){ return y(d.percent_add_hs_add_retd_mid) })
          .text(function(d){ return PERCENT(d.percent_add_hs_add_retd_mid)})

        d3.selectAll(".barAddHS").transition()
          .attr("y", function(d) { return y(d.percent_add_hs); })
          .attr("height", function(d) { return height - y(d.percent_add_hs); });
        d3.selectAll(".textAddHS")
          .attr("y", function(d){ return y(d.percent_add_hs) })
          .text(function(d){ return PERCENT(d.percent_add_hs)})

        stepCount += 1;    
        greyNext();
        d3.select(".yText").transition().style("opacity",0)
        setTimeout(function(){
          percentDisplay();
        },1900);
        lowerLabel();
      }
      else if(stepCount == 3 && prev){
        d3.select(".stepText.one").transition().style("opacity",0)
        d3.select(".stepText.two").transition().style("opacity",1)
        d3.select(".stepText.three").transition().style("opacity",0)
        yAxis.ticks(10, "$,");
        y.domain([0,1940])
        svg.select(".y.axis").transition().duration(700).call(yAxis);

        d3.selectAll(".barAddRETD_MID").transition()
          .attr("y", function(d) { return y(d.dollars_add_hs_add_retd_mid); })
          .attr("height", function(d) { return height - y(d.dollars_add_hs_add_retd_mid); });
        d3.selectAll(".textAddRETD_MID")
          .attr("y", function(d){ return y(d.dollars_add_hs_add_retd_mid) })
          .text(function(d){ return DOLLARS(d.dollars_add_hs_add_retd_mid)})

        d3.selectAll(".barAddHS").transition()
          .attr("y", function(d) { return y(d.dollars_add_hs); })
          .attr("height", function(d) { return height - y(d.dollars_add_hs); });
        d3.selectAll(".textAddHS")
          .attr("y", function(d){ return y(d.dollars_add_hs) })
          .text(function(d){ return DOLLARS(d.dollars_add_hs)})

        stepCount -= 1;    
        greyNone();
        dollarDisplay();
        showLabel();
      }
    })
  });
}
drawGraphic();
d3.select(window).on("resize", drawGraphic);

</script>